# 🧠 웹 페이지 업데이트

---

## ✅ 전제 개념: 무엇이 업데이트인가?

> 웹 페이지가 “업데이트된다”는 것은
> 결국 \*\*화면에 보이는 픽셀(Render Output)\*\*이 바뀐다는 뜻입니다.

이 변화는 대부분 다음 세 가지 원인 중 하나로 시작됩니다:

1. 사용자 상호작용 (클릭, 입력 등)
2. 타이머(setTimeout, requestAnimationFrame)
3. 네트워크 응답 (AJAX, fetch)

---

## ✅ 전체 업데이트 순서: Overview


<img src="./images/page_update_pipeline.svg" style="width:30%; height:auto;" /><br>



---

## 🔍 1. 이벤트 발생 또는 JavaScript 실행

* 이벤트 핸들러에서 DOM 조작 (`.textContent`, `.classList`, `.style`)
* 또는 직접 스타일 변경 (`element.style.backgroundColor = "red"`)
* 또는 애니메이션 루프/타이머 (`setTimeout`, `setInterval`, `requestAnimationFrame`)

---

## 🔍 2. DOM 또는 CSSOM 변경

JS에 의해 다음 중 하나가 바뀝니다:

* **DOM 구조**: 요소 추가/삭제/속성변경
* **CSSOM**: 클래스 변경, 스타일 직접 수정
* 이 변화가 있으면 브라우저는 **렌더링 업데이트가 필요함을 인식**합니다

📌 브라우저는 즉시 다시 그리는 것이 아니라, **렌더링을 “예약”합니다**
→ 즉, 가능한 변경을 묶어서 처리하려고 합니다 (Batching)

---

## 🔍 3. Style 계산 (스타일 재계산)

### Style recalc 발생 조건:

* 클래스 변경
* 스타일 속성 변경
* 외부 CSS 규칙에 의한 영향

### 결과:

* 기존 CSSOM 트리를 기반으로 변경된 요소에 대한 **정확한 스타일 계산**이 다시 이루어짐
* `getComputedStyle()` 등이 이 과정 후 값 제공

---

## 🔍 4. Layout 단계 (Reflow)

> 요소의 **위치, 크기, 박스 모델(box-sizing)** 등을 다시 계산

발생 조건:

* `width`, `height`, `padding`, `display`, `position`, `transform` 등의 변경
* 또는 DOM에 노드 추가/제거

💥 이 단계는 매우 비쌈. 성능 최적화에서 가장 중요한 단계 중 하나.

예:

```js
element.style.width = "500px";
element.offsetHeight; // 강제로 Layout 발생
```

---

## 🔍 5. Paint 단계 (Rasterization)

> 요소의 픽셀을 실제 그리기 위한 작업

* 배경색, 텍스트, 테두리, 그림자 등 시각적 스타일을 **화면 좌표 공간으로 변환**
* Paint는 종종 GPU 대신 CPU로 처리되며, **Paint 영역이 넓을수록 비용이 큽니다**

---

## 🔍 6. Composite 단계

> 여러 레이어를 GPU에서 조합하여 최종 화면을 완성

* `transform`, `opacity`, `will-change`, `fixed` 요소 등은 GPU 레이어로 분리될 수 있음
* Paint된 레이어들을 GPU가 합성함 → 최종 프레임 버퍼로 렌더링

---

## 🔍 7. 화면 업데이트

* 위 과정을 거쳐 모든 게 완료되면,
* \*\*다음 vsync 타이밍 (\~16.6ms 마다)\*\*에 맞춰 브라우저가 GPU로부터 프레임을 스크린에 전달합니다.
* 이게 실제 사용자 눈에 보이는 업데이트입니다.

---

## 🧩 전체 타이밍 흐름 (requestAnimationFrame 포함)

```plaintext
JS 실행 중...
 ↓
DOM 변경
 ↓
→ 렌더 예약됨 (브라우저 내부 큐에 배치)
 ↓
requestAnimationFrame() → 다음 프레임 요청
 ↓
📌 60fps 기준: 약 16.6ms 마다 프레임 동기화
 ↓
✔ style → layout → paint → composite 실행
 ↓
🖥 실제 렌더링 완료
```

---

## 🧪 예제: DOM 조작으로 업데이트 발생

```html
<button onclick="change()">Update</button>
<p id="text">안녕하세요</p>

<script>
  function change() {
    const el = document.getElementById("text");
    el.textContent = "반가워요!";        // DOM 변경
    el.style.color = "blue";             // CSSOM 변경
    // offsetHeight로 강제 Layout 발생 가능
  }
</script>
```

---

## 📘 브라우저 최적화 팁

| 구분                         | 설명                                        |
| -------------------------- | ----------------------------------------- |
| Layout 최소화                 | DOM 접근은 읽기와 쓰기를 나눠서 처리                    |
| GPU 레이어 분리                 | `will-change`, `transform: translateZ(0)` |
| Paint 최적화                  | 그림자, 둥근 모서리 등 스타일 최소화                     |
| `requestAnimationFrame` 사용 | 애니메이션 시 렌더링과 동기화                          |

---

## 🧠 최종 요약

| 단계              | 설명             | 비용     |
| --------------- | -------------- | ------ |
| JS 실행           | DOM/CSS 변경 유발  | 낮음\~중간 |
| Style 계산        | 속성 변경시 스타일 재계산 | 중간     |
| Layout (Reflow) | 위치/크기 변경 시     | **높음** |
| Paint           | 시각 요소 변경       | 중간     |
| Composite       | GPU 레이어 합성     | 낮음\~중간 |

